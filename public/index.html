<!doctype html>
<html lang="ja" ng-app="myApp">

<head>
  <meta charset="utf-8">
  <title>Angularjs Component & svelte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
</head>

<body>
  <h1>angularjsコンポーネントスタイル内で svelte を使用するサンプル</h1>
  <app></app>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.9/angular.min.js"></script>
  <!-- svelteのバンドルファイル読み込み -->
  <script src="./dist/main.js"></script>
  <!-- angularjs component -->
  <script>
    !(function() {
    'use strict';

    angular.module('myApp', []).component('app', {
      controller: ['$scope', AppCtrl],
      template:
        '<div style="border: red solid 1px;">' +
        '  <p>angularjs app component</p>' +
        '  <children></children>' +
        '  <div ng-if="!!$ctrl.isShowComment">{{$ctrl.comment}}</div>' +
        '  <button type="button" ng-click="$ctrl.reset()">RESET</button>' +
        '</div>'
    }).component('children', { // 子コンポーネントで svelte コンポーネントを使用してみる
      controller: ['$scope', ChildrenCtrl],
      template:
        '<div style="border: blue solid 1px;">'+
        '  <p>angularjs children component</p>'+
        '  <input type="text"'+
        '         ng-change="$ctrl.changeName()"' +
        '         ng-model="$ctrl.name" />'+
        '  <div class="children_svelteGreeting"></div>'+
        '  <p>click: {{$ctrl.count}}</p>'+
        '  <div class="children_svelteButton"></div>'+
        '  <div class="children_svelteCustomEvent"></div>'+
        '</div>'
    });

    function AppCtrl($scope) {
      var commentFn = this.comment.bind(this);

      this.$scope = $scope;
      this.$onInit = function() {
        this.comment = "Initialized comment";
        document.addEventListener('svelte:showComment', commentFn);
      }

      this.$onDestroy = function() {
        document.removeEventListener('svelte:showComment', commentFn);
      };
    }

    AppCtrl.prototype.comment = function(e) {
      this.$scope.$apply(function() {
        this.isShowComment = true;
        this.comment = e.detail.text;
      }.bind(this))
    }

    AppCtrl.prototype.reset = function() {
      this.isShowComment = false;
      this.comment = null;
    }

    function ChildrenCtrl($scope) {
      this.$scope = $scope;
      this.$onInit = function() {
        this.count = 0;

        // svelte コンポーネントを追加: propsを外部で更新して変更されるか
        // TODO: props で渡した値が親で更新されたときに反映する方法
        this.svelteGreeting = new svelteGreeting({
          target: document.querySelector('.children_svelteGreeting'),
          props: {
            name: this.name
          }
        })

        // svelte コンポーネントを追加: 関数を渡して実行するパターン
        new svelteButton({
          target: document.querySelector('.children_svelteButton'),
          props: {
            buttonLabel: 'プラス1',
            clickFn: this.click.bind(this)
          }
        })

        // CustomEvent で親より上とコミュニケーションするサンプル
        new svelteCustomEvent({
          target: document.querySelector('.children_svelteCustomEvent'),
        })
      }
    }
    ChildrenCtrl.prototype.click = function() {
      // this.count++;
      // svelteコンポーネントでのクリックを反映させるために $apply
      this.$scope.$apply(function() {
        this.count++;
      }.bind(this))
    }
    ChildrenCtrl.prototype.changeName = function() {
      // svelte コンポーネントの props を更新
      // $inject_state は devtoolなので使用しないように注意
      // https://twitter.com/sveltejs/status/1203024631390715912
      // >> Same answer for `app.$inject_state`? Why does that exist, since it's exactly the same as `app.$set`?
      // > That's another dev mode hook, used for hot module reloading
      this.svelteGreeting.$$set({name: this.name});
    }
  })();

  </script>
</body>
</html>